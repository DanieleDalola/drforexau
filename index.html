

<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>DR-Forexau – Dashboard</title>

  <!-- PWA -->
  <link rel="manifest" href="/manifest.json">
  <meta name="theme-color" content="#0b0f14">

  <!-- Icone -->
  <link rel="icon" type="image/png" href="/icons/icon-192.png">
  <link rel="apple-touch-icon" href="/icons/icon-512.png">

  <style>
    html,body{
      height:100%;
      margin:0;
      font-family:system-ui,-apple-system,Segoe UI,Roboto;
      background:#0b0f14;
      color:#fff;
    }
    .wrap{
      min-height:100%;
      display:flex;
      flex-direction:column;
      gap:16px;
    }
    header{
      padding:12px 16px;
      border-bottom:1px solid #223;
    }
    h3{margin:0}
    h4{margin:0}
    .row{
      display:flex;
      align-items:center;
      gap:12px;
      flex-wrap:wrap;
    }
    select{
      background:#111;
      border:1px solid #334;
      color:#fff;
      border-radius:10px;
      padding:6px 10px;
    }
    .card{
      background:#0e141b;
      border:1px solid #223;
      border-radius:16px;
      padding:12px 16px;
      margin:0 12px 8px;
    }
    .chart{
      height:70vh;
      min-height:420px;
    }
    .muted{
      opacity:.8;
      font-size:12px;
    }
    .toast{
      position:fixed;
      right:16px;
      bottom:16px;
      z-index:9999;
      background:#0b0f14;
      border:1px solid #334;
      border-radius:14px;
      padding:12px 14px;
      box-shadow:0 10px 30px rgba(0,0,0,.35);
      max-width:360px;
      font-size:13px;
    }
    button{
      padding:8px 12px;
      border-radius:10px;
      border:1px solid #334;
      background:#111;
      color:#fff;
      cursor:pointer;
    }
    button:hover{background:#132}
    .pill{
      display:inline-flex;
      align-items:center;
      border:1px solid #334;
      border-radius:999px;
      padding:2px 8px;
      font-size:12px;
      gap:6px;
    }
    .dot{
      width:8px;
      height:8px;
      border-radius:999px;
      background:#16a34a;
    }
    #levels{
      height:280px;
      border:1px solid #223;
      border-radius:12px;
      margin-top:8px;
    }
    label{
      font-size:13px;
      display:flex;
      flex-direction:column;
      gap:4px;
    }
    input{
      background:#111;
      border:1px solid #334;
      border-radius:10px;
      padding:8px 10px;
      color:#fff;
      width:100%;
    }
    table{
      width:100%;
      border-collapse:collapse;
      font-size:12px;
    }
    th,td{
      padding:4px 6px;
      text-align:left;
    }
    thead th{
      border-bottom:1px solid #223;
      font-weight:600;
    }
    tbody tr:nth-child(even){
      background:#0b1017;
    }
    .badge{
      display:inline-block;
      padding:2px 6px;
      border-radius:999px;
      font-size:11px;
    }
    .badge-win{ background:#052e16; color:#bbf7d0; }
    .badge-loss{ background:#450a0a; color:#fecaca; }
    .badge-open{ background:#111827; color:#e5e7eb; }

    /* Bottone install PWA sempre visibile */
    .install-btn {
      margin-left:8px;
      padding:8px 14px;
      border-radius:999px;
      border:1px solid #334155;
      background:#020617;
      color:#e2e8f0;
      font-size:13px;
      display:inline-flex;
      align-items:center;
      gap:6px;
      cursor:pointer;
    }
    .install-btn span {
      font-size:16px;
    }
    .install-btn:hover {
      background:#0f172a;
    }

    /* Scritta risk management */
    #risk-note{
      width:100%;
      text-align:center;
      font-size:18px;
      font-weight:900;
      letter-spacing:1px;
      margin-top:-4px;
      margin-bottom:0;
      color:#fbbf24;
    }
  </style>

  <!-- Service worker -->
  <script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('/service-worker.js')
          .then(reg => console.log("SW ok", reg))
          .catch(err => console.error("SW error", err));
      });
    }
  </script>
</head>
<body>

<!-- ====== VIEW LOGIN ====== -->
<div id="auth-view" class="wrap" style="display:flex;justify-content:center;align-items:center;">
  <div class="card" style="max-width:420px;width:100%;margin:40px 16px;">
    <h3>DR-Forexau — Login</h3>
    <p class="muted" style="margin-top:6px">
      Inserisci email e password (Supabase Auth) per accedere alla dashboard.
    </p>
    <form id="login-form" style="margin-top:12px;display:flex;flex-direction:column;gap:10px;">
      <label>
        Email
        <input id="email" type="email" autocomplete="email" required />
      </label>
      <label>
        Password
        <input id="password" type="password" autocomplete="current-password" required />
      </label>
      <button type="submit">Entra</button>
      <div id="login-msg" class="muted"></div>
    </form>
    <p class="muted" style="margin-top:10px;font-size:11px">
      Se l'utente non esiste ancora, il sistema proverà a crearlo con questa email.
    </p>
  </div>
</div>

<!-- ====== VIEW APP ====== -->
<div id="app-view" class="wrap" style="display:none;">

  <header>
    <div class="row" style="justify-content:space-between">
      <div class="row" style="gap:8px">
        <h3>DR-Forexau — Dashboard</h3>
        <span id="user-email-label" class="muted"></span>
      </div>
      <div class="row">
        <label style="flex-direction:row;align-items:center;gap:6px;">
          <span>Simbolo:</span>
          <select id="symbol">
            <option value="OANDA:XAUUSD">XAUUSD (OANDA)</option>
            <option value="FX_IDC:XAUUSD">XAUUSD (FX_IDC)</option>
            <option value="OANDA:XAGUSD">XAGUSD (Argento)</option>
            <option value="OANDA:EURUSD">EURUSD</option>
          </select>
        </label>

        <!-- Bottone install sempre visibile -->
        <button id="install-btn" type="button" class="install-btn">
          <span>⬇️</span> Installa app
        </button>

        <button id="logout-btn" type="button">Logout</button>
      </div>
    </div>
  </header>

  <!-- Scritta di risk management -->
  <div id="risk-note">DOPO 30/40 PIPS STOP A BE</div>

  <!-- DASHBOARD SEGNALI -->
  <div class="card">
    <div class="row" style="justify-content:space-between;align-items:flex-end;">
      <div>
        <h4>Dashboard segnali</h4>
        <div class="muted">Ultimi 50 segnali registrati dal bot Telegram</div>
      </div>
      <div class="row" style="gap:16px;font-size:13px;">
        <div>Winrate: <strong id="stat-winrate">—</strong></div>
        <div>Vinte: <strong id="stat-wins">0</strong></div>
        <div>Perse: <strong id="stat-losses">0</strong></div>
        <div>Aperte: <strong id="stat-open">0</strong></div>
      </div>
    </div>
    <div style="margin-top:8px;max-height:260px;overflow:auto;">
      <table id="signals-table">
        <thead>
          <tr>
            <th>Ora</th>
            <th>Symbol</th>
            <th>Side</th>
            <th>Tipo</th>
            <th>Entry</th>
            <th>SL</th>
            <th>TP</th>
            <th>Risultato</th>
          </tr>
        </thead>
        <tbody id="signals-body"></tbody>
      </table>
    </div>
  </div>

  <!-- GRAFICO TRADINGVIEW -->
  <div class="card">
    <div id="tv" class="chart"></div>
  </div>

  <!-- LEVELS -->
  <div class="card">
    <div class="row" style="justify-content:space-between">
      <h4>Levels</h4>
      <span class="pill">
        <span class="dot" id="pending-dot"></span>
        <span id="pending-label">Attivo/Market</span>
      </span>
    </div>
    <div id="levels"></div>
  </div>

</div>

<!-- TradingView widget -->
<script src="https://s3.tradingview.com/tv.js"></script>
<!-- Supabase client -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<!-- Lightweight Charts -->
<script src="https://unpkg.com/lightweight-charts@4.2.0/dist/lightweight-charts.standalone.production.js"></script>

<script>
// ========================
// LOGGER
// ========================
function log(msg){
  console.log(msg);
}

// ========================
// SUPABASE CLIENT
// ========================
const SUPABASE_URL  = "https://xiiefkpnnraqcvypkktc.supabase.co";
const SUPABASE_ANON = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhpaWVma3BubnJhcWN2eXBra3RjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjMzOTU4MzAsImV4cCI6MjA3ODk3MTgzMH0.F8w_EIN3taFZjl3oHZ3OYhJxW5JJJ3BqM0u9v8r4nWo";

const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON);

// ========================
// DOM ELEMENTS
// ========================
const authView        = document.getElementById('auth-view');
const appView         = document.getElementById('app-view');
const loginForm       = document.getElementById('login-form');
const loginMsg        = document.getElementById('login-msg');
const emailInput      = document.getElementById('email');
const passwordInput   = document.getElementById('password');
const userEmailLabel  = document.getElementById('user-email-label');
const logoutBtn       = document.getElementById('logout-btn');
const installBtn      = document.getElementById('install-btn');

let currentUserEmail = '';
let dataStarted = false;

// ========================
// LOGIN / LOGOUT VIEW
// ========================
function showApp(){
  authView.style.display = 'none';
  appView.style.display  = 'flex';
  userEmailLabel.textContent = currentUserEmail ? `(${currentUserEmail})` : '';
  if (!dataStarted){
    dataStarted = true;
    startDataStreams();
  }
}

function showLogin(){
  authView.style.display = 'flex';
  appView.style.display  = 'none';
  loginMsg.textContent = '';
  toast.style.display = 'none';
}

loginForm.addEventListener('submit', async (e) => {
  e.preventDefault();
  loginMsg.textContent = 'Accesso in corso...';

  const email = emailInput.value.trim();
  const password = passwordInput.value;

  try{
    let { data, error } = await sb.auth.signInWithPassword({ email, password });

    if (error && error.message && error.message.includes('Invalid login credentials')) {
      const signUp = await sb.auth.signUp({ email, password });
      if (signUp.error) throw signUp.error;
      data = signUp.data;
    } else if (error) {
      throw error;
    }

    currentUserEmail = (data && data.user && data.user.email) || email;
    loginMsg.textContent = '';
    showApp();
  }catch(err){
    console.error(err);
    loginMsg.textContent = 'Errore login: ' + (err.message || err);
  }
});

logoutBtn.addEventListener('click', async () => {
  try{
    await sb.auth.signOut();
  }catch(e){
    console.error(e);
  }
  currentUserEmail = '';
  showLogin();
});

// ========================
// TRADINGVIEW
// ========================
let tvWidget;
const sel = document.getElementById('symbol');

function renderTV(symbol){
  try{
    document.getElementById('tv').innerHTML = '';
    tvWidget = new TradingView.widget({
      symbol,
      interval: "15",
      container_id: "tv",
      autosize: true,
      theme: "dark",
      style: "1",
      locale: "it",
      withdateranges: true,
      hide_side_toolbar: false,
      hide_top_toolbar: false,
      timezone: "Europe/Rome",
    });
    log("TradingView ok: "+symbol);
  }catch(e){
    log("TradingView error: "+(e.message||e));
  }
}

sel.addEventListener('change', () => renderTV(sel.value));

// ========================
// LEVELS (LIGHTWEIGHT CHARTS)
// ========================
let chart, series, priceLines = [];

function initLevels(){
  try{
    const el = document.getElementById('levels');
    el.innerHTML = '';
    chart = LightweightCharts.createChart(el, {
      height: 280,
      layout: { background: { color:'#0b0f14' }, textColor:'#cbd5e1' },
      rightPriceScale: { borderColor:'#1f2937' },
      timeScale: { visible:false, borderColor:'#1f2937' },
      grid: { vertLines:{ color:'#111827' }, horzLines:{ color:'#111827' } },
    });
    series = chart.addLineSeries({ color:'#999' });
    log("Levels chart ok");
  }catch(e){
    log("Levels init error: "+(e.message||e));
  }
}

function drawLevels(sig){
  try{
    if (!series) initLevels();

    priceLines.forEach(pl => series.removePriceLine(pl));
    priceLines = [];

    const side = (sig.side||'').toUpperCase();
    const kind = (sig.order_kind||'market').toLowerCase();
    const isPending = !sig.filled_at && (kind==='limit' || kind==='stop');

    const n = v => (v==null ? NaN : Number(v));
    const entry = n(sig.entry), sl = n(sig.sl), tp = n(sig.tp);

    const entryColor = isPending ? '#eab308' : (side==='BUY' ? '#16a34a' : '#ef4444');
    const entryStyle = isPending ? LightweightCharts.LineStyle.Dotted
                                 : LightweightCharts.LineStyle.Solid;

    if (!Number.isNaN(entry)){
      priceLines.push(series.createPriceLine({
        price: entry,
        color: entryColor,
        lineWidth: 2,
        lineStyle: entryStyle,
        title: `ENTRY ${entry}${isPending?' (pend.)':''}`,
      }));
    }
    if (!Number.isNaN(sl)){
      priceLines.push(series.createPriceLine({
        price: sl,
        color: '#ef4444',
        lineWidth: 1,
        title: `SL ${sl}`,
      }));
    }
    if (!Number.isNaN(tp)){
      priceLines.push(series.createPriceLine({
        price: tp,
        color: '#16a34a',
        lineWidth: 1,
        title: `TP ${tp}`,
      }));
    }

    const dot = document.getElementById('pending-dot');
    const lab = document.getElementById('pending-label');
    if (isPending){
      dot.style.background='#eab308';
      lab.textContent='Pendente';
    } else {
      dot.style.background='#16a34a';
      lab.textContent='Attivo/Market';
    }

    log(`Drawn levels: side=${side} kind=${kind} entry=${entry} sl=${sl} tp=${tp}`);
  }catch(e){
    log("drawLevels error: "+(e.message||e));
  }
}

// ========================
// TOAST ULTIMO SEGNALE
// ========================
const toast = document.createElement('div');
toast.className = 'toast';
toast.style.display = 'none';
toast.innerHTML = `
  <div style="font-weight:700">Ultimo segnale</div>
  <div id="sg-line" style="margin-top:4px"></div>
  <div id="sg-sub" class="muted"></div>
  <div class="row" style="margin-top:8px">
    <button id="sg-open">Apri sul grafico</button>
    <button id="sg-close" style="background:#1b0f0f;border-color:#442">Chiudi</button>
  </div>
`;
document.body.appendChild(toast);

const eLine = toast.querySelector('#sg-line');
const eSub  = toast.querySelector('#sg-sub');
let lastSignal = null;

function showSignal(s){
  try{
    lastSignal = s;
    const side = (s.side||'').toUpperCase();
    const color = side === 'BUY' ? '#16a34a' : '#ef4444';
    const kind = (s.order_kind||'market').toUpperCase();

    eLine.innerHTML = `<span style="color:${color}">${side}</span> ${s.symbol} @ ${s.entry} <span class="muted">(${kind})</span>`;
    eSub.textContent = `SL ${s.sl ?? '—'} · TP ${s.tp ?? '—'}`;

    drawLevels(s);

    if (appView.style.display !== 'none') {
      toast.style.display = 'block';
    }

    log("Mostrato ultimo segnale.");
  }catch(e){
    log("showSignal error: "+(e.message||e));
  }
}

document.addEventListener('click', (e) => {
  if (e.target && e.target.id === 'sg-open') {
    try{
      if (!lastSignal) return;
      const code = (lastSignal.symbol || 'XAUUSD').toUpperCase();
      const preferred =
        code === 'XAUUSD' ? 'OANDA:XAUUSD' :
        code === 'XAGUSD' ? 'OANDA:XAGUSD' :
        code === 'EURUSD' ? 'OANDA:EURUSD' : 'OANDA:XAUUSD';
      sel.value = preferred;
      sel.dispatchEvent(new Event('change'));
    }catch(err){
      log("sg-open error: "+(err.message||err));
    }
  }
  if (e.target && e.target.id === 'sg-close') {
    toast.style.display = 'none';
  }
});

// ========================
// DASHBOARD / WINRATE
// ========================
const tbodySignals = document.getElementById('signals-body');
const statWinrate  = document.getElementById('stat-winrate');
const statWins     = document.getElementById('stat-wins');
const statLosses   = document.getElementById('stat-losses');
const statOpen     = document.getElementById('stat-open');

function formatDate(iso){
  if (!iso) return '';
  const d = new Date(iso);
  return d.toLocaleString('it-IT', { hour:'2-digit', minute:'2-digit', day:'2-digit', month:'2-digit' });
}

function renderDashboardRows(rows){
  tbodySignals.innerHTML = '';
  let wins=0, losses=0, open=0;

  (rows || []).forEach(r => {
    const res = (r.result || '').toLowerCase();
    if (res === 'win') wins++;
    else if (res === 'loss') losses++;
    else open++;

    let badge;
    if (res === 'win') badge = '<span class="badge badge-win">Win</span>';
    else if (res === 'loss') badge = '<span class="badge badge-loss">Loss</span>';
    else badge = '<span class="badge badge-open">Open</span>';

    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${formatDate(r.created_at)}</td>
      <td>${r.symbol || ''}</td>
      <td>${(r.side||'').toUpperCase()}</td>
      <td>${(r.order_kind||'').toUpperCase()}</td>
      <td>${r.entry ?? ''}</td>
      <td>${r.sl ?? ''}</td>
      <td>${r.tp ?? ''}</td>
      <td>${badge}</td>
    `;
    tbodySignals.appendChild(tr);
  });

  const closed = wins + losses;
  let wr = '—';
  if (closed > 0){
    wr = ((wins / closed) * 100).toFixed(1) + '%';
  }

  statWinrate.textContent = wr;
  statWins.textContent    = wins;
  statLosses.textContent  = losses;
  statOpen.textContent    = open;
}

async function loadDashboard(){
  try{
    const { data, error } = await sb
      .from('signals')
      .select('*')
      .order('created_at', { ascending:false })
      .limit(50);

    if (error){
      log("loadDashboard error: "+error.message);
      return;
    }
    renderDashboardRows(data || []);
  }catch(e){
    log("loadDashboard exception: "+(e.message||e));
  }
}

// ========================
// SUPABASE: ULTIMO SEGNALE + REALTIME
// ========================
async function loadInitialSignal(){
  try{
    const { data, error } = await sb
      .from('signals')
      .select('*')
      .order('created_at', { ascending:false })
      .limit(1);

    if (error){
      log("loadInitialSignal error: "+error.message);
      return;
    }
    if (data && data.length){
      showSignal(data[0]);
    }else{
      log("Nessun segnale in tabella.");
    }
  }catch(e){
    log("loadInitialSignal exception: "+(e.message||e));
  }
}

let realtimeChannel = null;

function setupRealtime(){
  if (realtimeChannel) return;

  realtimeChannel = sb.channel('signals-feed')
    .on('postgres_changes', { event:'INSERT', schema:'public', table:'signals' }, (payload) => {
      log("Realtime INSERT ricevuto");
      showSignal(payload.new);
      loadDashboard();
    })
    .on('postgres_changes', { event:'UPDATE', schema:'public', table:'signals' }, () => {
      loadDashboard();
    })
    .subscribe((status) => {
      log("Realtime status: "+(status||'unknown'));
    });
}

async function startDataStreams(){
  renderTV(sel.value);
  initLevels();
  await loadDashboard();
  await loadInitialSignal();
  setupRealtime();
}

// ========================
// PWA INSTALL BUTTON
// ========================
let deferredPrompt = null;

window.addEventListener('beforeinstallprompt', (e) => {
  e.preventDefault();
  deferredPrompt = e;
  console.log('beforeinstallprompt ricevuto');
});

if (installBtn) {
  installBtn.addEventListener('click', async () => {
    try {
      if (!deferredPrompt) {
        alert('Se non vedi il popup, usa il menu del browser per installare l’app.');
        return;
      }
      deferredPrompt.prompt();
      const { outcome } = await deferredPrompt.userChoice;
      console.log('User choice:', outcome);
      deferredPrompt = null;
    } catch (err) {
      console.error('Errore install PWA:', err);
    }
  });
}

// ========================
// BOOTSTRAP
// ========================
(async () => {
  try{
    const { data } = await sb.auth.getSession();
    if (data && data.session && data.session.user){
      currentUserEmail = data.session.user.email;
      showApp();
    }else{
      showLogin();
    }
  }catch(e){
    console.error(e);
    showLogin();
  }
})();
</script>

</body>
</html>




